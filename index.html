<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta http-equiv="Permissions-Policy" content="camera=*, microphone=*">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AsistenciaQR ‚Äî Control de Asistencia Escolar</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;0,9..40,800&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<style>
:root{--primary:#1e3a5f;--primary-mid:#2a5a8c;--primary-light:#3b82f6;--primary-lighter:#eff6ff;--accent:#0ea5e9;--accent-glow:rgba(14,165,233,0.15);--success:#10b981;--success-bg:#ecfdf5;--warning:#f59e0b;--warning-bg:#fffbeb;--danger:#ef4444;--danger-bg:#fef2f2;--bg:#f1f5f9;--card:#fff;--border:#e2e8f0;--text:#0f172a;--text-secondary:#475569;--text-muted:#94a3b8;--shadow:0 1px 3px rgba(0,0,0,.06),0 1px 2px rgba(0,0,0,.04);--shadow-md:0 4px 8px rgba(0,0,0,.06),0 2px 4px rgba(0,0,0,.04);--shadow-lg:0 12px 28px rgba(0,0,0,.1);--radius:14px;--radius-sm:10px;--radius-xs:6px;--tr:0.2s cubic-bezier(.4,0,.2,1)}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'DM Sans',system-ui,sans-serif;background:var(--bg);color:var(--text);min-height:100vh;-webkit-font-smoothing:antialiased;-webkit-overflow-scrolling:touch;overflow-y:auto}
.app-header{background:linear-gradient(135deg,#0f2b46,#1e3a5f 40%,#1a5276);padding:18px 20px;color:#fff;z-index:100;box-shadow:0 4px 20px rgba(15,43,70,.35)}
.header-inner{max-width:1200px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;gap:12px}
.app-logo{display:flex;align-items:center;gap:12px}
.logo-icon{width:42px;height:42px;background:rgba(255,255,255,.12);border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:22px;border:1px solid rgba(255,255,255,.1)}
.app-title{font-size:22px;font-weight:800;letter-spacing:-.3px}
.app-subtitle{font-size:11px;opacity:.6;text-transform:uppercase;letter-spacing:1px}
.header-right{display:none}


.nav-tabs{background:var(--card);border-bottom:1px solid var(--border);display:flex;overflow-x:auto;scrollbar-width:none;position:sticky;top:0;z-index:99}
.nav-tabs::-webkit-scrollbar{display:none}
.nav-tab{flex:1;min-width:fit-content;padding:14px 18px;text-align:center;cursor:pointer;font-size:13px;font-weight:500;color:var(--text-muted);border-bottom:3px solid transparent;transition:all var(--tr);white-space:nowrap;display:flex;align-items:center;justify-content:center;gap:7px;user-select:none}
.nav-tab:hover{color:var(--primary);background:var(--primary-lighter)}
.nav-tab.active{color:var(--primary);border-bottom-color:var(--accent);font-weight:700;background:var(--primary-lighter)}
.tab-icon{font-size:16px}
.main-content{max-width:1200px;margin:0 auto;padding:20px}
.tab-panel{display:none;animation:fadeIn .3s}
.tab-panel.active{display:block}
@keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
.card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:22px;margin-bottom:16px;border:1px solid var(--border)}
.card-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;flex-wrap:wrap;gap:10px}
.card-title{font-size:16px;font-weight:700;display:flex;align-items:center;gap:8px}
.btn{display:inline-flex;align-items:center;gap:6px;padding:9px 16px;border:none;border-radius:var(--radius-sm);font-family:'DM Sans',sans-serif;font-size:13px;font-weight:600;cursor:pointer;transition:all var(--tr);white-space:nowrap}
.btn:active{transform:scale(.97)}
.btn-primary{background:var(--primary);color:#fff}.btn-primary:hover{background:#162d4d}
.btn-accent{background:var(--accent);color:#fff}.btn-accent:hover{background:#0284c7}
.btn-success{background:var(--success);color:#fff}.btn-success:hover{background:#059669}
.btn-warning{background:var(--warning);color:#fff}.btn-warning:hover{background:#d97706}
.btn-danger{background:var(--danger);color:#fff}.btn-danger:hover{background:#dc2626}
.btn-outline{background:transparent;color:var(--text-secondary);border:1.5px solid var(--border)}.btn-outline:hover{background:var(--bg)}
.btn-whatsapp{background:#25D366;color:#fff}.btn-whatsapp:hover{background:#1ebe5d}
.btn-sm{padding:6px 11px;font-size:12px;border-radius:var(--radius-xs)}
.btn-lg{padding:13px 26px;font-size:15px}
.btn-group{display:flex;gap:8px;flex-wrap:wrap}
.form-group{margin-bottom:14px}
.form-label{display:block;font-size:12px;font-weight:600;color:var(--text-secondary);margin-bottom:6px;text-transform:uppercase;letter-spacing:.5px}
.form-input,.form-select,.form-textarea{width:100%;padding:11px 14px;border:1.5px solid var(--border);border-radius:var(--radius-sm);font-family:'DM Sans',sans-serif;font-size:14px;color:var(--text);background:var(--card);transition:border-color var(--tr),box-shadow var(--tr)}
.form-input:focus,.form-select:focus,.form-textarea:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px var(--accent-glow)}
.form-input::placeholder{color:var(--text-muted)}
.form-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px}
.table-wrapper{overflow-x:auto;margin:0 -22px;padding:0 22px}
table{width:100%;border-collapse:collapse;font-size:13px}
th{text-align:left;padding:11px 12px;font-weight:700;color:var(--text-secondary);border-bottom:2px solid var(--border);font-size:11px;text-transform:uppercase;letter-spacing:.6px;white-space:nowrap;background:var(--bg)}
td{padding:11px 12px;border-bottom:1px solid #f1f5f9;vertical-align:middle}
tr:hover td{background:var(--primary-lighter)}
.table-empty{text-align:center;padding:40px 20px;color:var(--text-muted)}
.table-empty-icon{font-size:44px;margin-bottom:10px;display:block;opacity:.6}
.badge{display:inline-flex;align-items:center;gap:4px;padding:4px 10px;border-radius:20px;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.3px}
.badge-success{background:var(--success-bg);color:var(--success)}
.badge-warning{background:var(--warning-bg);color:var(--warning)}
.badge-danger{background:var(--danger-bg);color:var(--danger)}
.badge-info{background:var(--primary-lighter);color:var(--primary)}
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:12px;margin-bottom:16px}
.stat-card{background:var(--card);border-radius:var(--radius-sm);padding:18px;text-align:center;border:1px solid var(--border);transition:transform var(--tr)}
.stat-card:hover{transform:translateY(-2px)}
.stat-number{font-size:30px;font-weight:800;line-height:1;margin-bottom:4px;letter-spacing:-1px}
.stat-label{font-size:11px;color:var(--text-muted);text-transform:uppercase;font-weight:600;letter-spacing:.5px}
.modal-overlay{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.55);z-index:200;align-items:center;justify-content:center;padding:20px;backdrop-filter:blur(6px);-webkit-backdrop-filter:blur(6px)}
.modal-overlay.active{display:flex}
.modal{background:var(--card);border-radius:var(--radius);width:100%;max-width:560px;max-height:88vh;overflow-y:auto;box-shadow:var(--shadow-lg);animation:modalIn .3s cubic-bezier(.34,1.56,.64,1)}
@keyframes modalIn{from{opacity:0;transform:scale(.92) translateY(12px)}}
.modal-header{display:flex;align-items:center;justify-content:space-between;padding:20px 22px;border-bottom:1px solid var(--border)}
.modal-title{font-size:18px;font-weight:700}
.modal-close{width:34px;height:34px;border:none;background:var(--bg);border-radius:8px;cursor:pointer;font-size:18px;display:flex;align-items:center;justify-content:center;color:var(--text-secondary);transition:all var(--tr)}
.modal-close:hover{background:var(--danger-bg);color:var(--danger)}
.modal-body{padding:22px}
.modal-footer{padding:16px 22px;border-top:1px solid var(--border);display:flex;gap:8px;justify-content:flex-end}
.scan-result{padding:16px;border-radius:var(--radius-sm);margin-bottom:12px;display:flex;align-items:center;gap:12px;animation:slideIn .3s}
@keyframes slideIn{from{opacity:0;transform:translateX(-10px)}}
.scan-result-success{background:var(--success-bg);border:1px solid #a7f3d0}
.scan-result-warning{background:var(--warning-bg);border:1px solid #fde68a}
.scan-result-error{background:var(--danger-bg);border:1px solid #fca5a5}
.scan-result-icon{font-size:30px}
.scan-result-content{flex:1}
.scan-result-name{font-size:16px;font-weight:700;margin-bottom:2px}
.scan-result-meta{font-size:12px;color:var(--text-secondary)}
.video-container{position:relative;width:100%;background:#000;border-radius:var(--radius-sm);overflow:hidden;margin-bottom:12px}
#qrVideo{width:100%;display:block;max-height:420px;object-fit:cover;-webkit-transform:translateZ(0);transform:translateZ(0)}
.video-container{touch-action:none;-webkit-user-select:none;user-select:none}
.scan-overlay{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:65%;max-width:260px;aspect-ratio:1;pointer-events:none}
.scan-frame{width:100%;height:100%;border:2px solid rgba(14,165,233,.6);border-radius:14px;box-shadow:0 0 0 2000px rgba(0,0,0,.45);position:relative}
.scan-corner{position:absolute;width:26px;height:26px;border:4px solid var(--accent)}
.scan-corner.tl{top:-2px;left:-2px;border-right:none;border-bottom:none;border-top-left-radius:14px}
.scan-corner.tr{top:-2px;right:-2px;border-left:none;border-bottom:none;border-top-right-radius:14px}
.scan-corner.bl{bottom:-2px;left:-2px;border-right:none;border-top:none;border-bottom-left-radius:14px}
.scan-corner.br{bottom:-2px;right:-2px;border-left:none;border-top:none;border-bottom-right-radius:14px}
.scan-line{position:absolute;left:4px;right:4px;height:3px;background:linear-gradient(90deg,transparent,var(--accent),transparent);border-radius:2px;box-shadow:0 0 12px var(--accent);animation:scanAnim 2s ease-in-out infinite}
@keyframes scanAnim{0%,100%{top:0;opacity:.2}50%{top:calc(100% - 3px);opacity:1}}
.camera-status{position:absolute;top:12px;left:12px;background:rgba(0,0,0,.7);color:#fff;padding:6px 14px;border-radius:20px;font-size:11px;font-weight:600;display:flex;align-items:center;gap:6px;backdrop-filter:blur(4px)}
.camera-status.active{background:rgba(16,185,129,.85)}
.camera-status-dot{width:8px;height:8px;border-radius:50%;background:currentColor;animation:pulse 1.5s ease-in-out infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}
.camera-select-bar{display:flex;align-items:center;gap:10px;margin-bottom:12px;padding:10px 14px;background:var(--bg);border-radius:var(--radius-sm);border:1px solid var(--border)}
.camera-select-bar label{font-size:12px;font-weight:600;color:var(--text-secondary);white-space:nowrap}
.method-tabs{display:flex;gap:8px;margin-bottom:16px}
.method-tab{flex:1;padding:12px;background:var(--bg);border:1.5px solid var(--border);border-radius:var(--radius-sm);cursor:pointer;text-align:center;font-size:13px;font-weight:500;color:var(--text-secondary);transition:all var(--tr);display:flex;align-items:center;justify-content:center;gap:6px}
.method-tab:hover{border-color:var(--accent);color:var(--primary)}
.method-tab.active{background:var(--primary);color:#fff;border-color:var(--primary)}
.method-content{display:none}
.method-content.active{display:block}
.toast-container{position:fixed;bottom:24px;left:50%;transform:translateX(-50%);z-index:400;display:flex;flex-direction:column-reverse;gap:8px;align-items:center}
.toast{background:var(--text);color:#fff;padding:12px 22px;border-radius:var(--radius-sm);font-size:13px;font-weight:500;box-shadow:var(--shadow-lg);animation:toastIn .3s;display:flex;align-items:center;gap:8px}
@keyframes toastIn{from{opacity:0;transform:translateY(12px)}}
.toast.success{background:var(--success)}.toast.error{background:var(--danger)}.toast.info{background:var(--primary)}
.drop-zone{border:2px dashed var(--border);border-radius:var(--radius);padding:35px;text-align:center;background:var(--bg);cursor:pointer;transition:all var(--tr)}
.drop-zone:hover,.drop-zone.dragover{border-color:var(--accent);background:var(--primary-lighter)}
.drop-zone-icon{font-size:42px;color:var(--text-muted);margin-bottom:8px}
.drop-zone-text{color:var(--text-secondary);font-size:13px}
.filters-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin-bottom:16px}
.qr-code-wrapper{display:flex;flex-direction:column;align-items:center;gap:12px;padding:20px;background:var(--bg);border-radius:var(--radius-sm)}
#qrcode{background:#fff;padding:16px;border-radius:10px;box-shadow:var(--shadow)}
.holiday-item{padding:12px 16px;background:var(--bg);border-radius:var(--radius-sm);margin-bottom:8px;display:flex;align-items:center;justify-content:space-between;border:1px solid var(--border)}
.holiday-date{font-weight:700;color:var(--primary);font-size:13px}
.holiday-name{color:var(--text-secondary);font-size:13px}
.time-display-card{background:linear-gradient(135deg,#0f2b46,#1a5276);color:#fff;border-radius:var(--radius);padding:24px;margin-bottom:16px;text-align:center;border:none;box-shadow:0 4px 20px rgba(15,43,70,.3)}
.time-display-clock{font-size:52px;font-weight:800;letter-spacing:-2px;line-height:1;margin-bottom:4px;font-variant-numeric:tabular-nums}
.time-display-date{font-size:15px;opacity:.8;margin-bottom:12px}
.time-display-status{display:inline-flex;align-items:center;gap:8px;padding:8px 18px;border-radius:24px;font-size:13px;font-weight:700;letter-spacing:.3px}
.status-ontime{background:rgba(16,185,129,.2);color:#6ee7b7;border:1px solid rgba(16,185,129,.3)}
.status-before{background:rgba(14,165,233,.2);color:#7dd3fc;border:1px solid rgba(14,165,233,.3)}
.status-late{background:rgba(245,158,11,.2);color:#fcd34d;border:1px solid rgba(245,158,11,.3)}
.progress-bar-wrap{width:100%;height:8px;background:var(--bg);border-radius:4px;overflow:hidden;margin:12px 0}
.progress-bar-fill{height:100%;background:var(--accent);border-radius:4px;transition:width .15s;width:0}
.progress-text{font-size:12px;color:var(--text-muted);text-align:center}
.credential-preview{background:#fff;border-radius:12px;border:2px solid var(--primary);padding:20px;text-align:center;max-width:320px;margin:0 auto;box-shadow:var(--shadow-md)}
.credential-header{background:linear-gradient(135deg,var(--primary),var(--primary-mid));color:#fff;padding:10px;border-radius:8px 8px 0 0;margin:-20px -20px 16px;font-size:13px;font-weight:700;letter-spacing:.5px}
.template-info{background:var(--primary-lighter);border:1px solid #bfdbfe;border-radius:var(--radius-sm);padding:14px 16px;margin-bottom:14px;font-size:13px;color:var(--primary);display:flex;align-items:flex-start;gap:10px}
.template-info-icon{font-size:20px;flex-shrink:0}
@media(max-width:768px){
  .header-inner{flex-direction:column;align-items:flex-start;gap:8px}
  
  
  .stats-grid{grid-template-columns:repeat(2,1fr)}
  .filters-row{grid-template-columns:1fr}
  .time-display-clock{font-size:38px}
  .btn-group{flex-direction:column}
  .btn-group .btn{width:100%;justify-content:center}
  .method-tabs{flex-direction:column;gap:6px}
  .nav-tab{padding:12px 14px;font-size:12px}
  .nav-tabs{position:relative;top:auto}
}
@media(max-width:480px){.main-content{padding:12px}.card{padding:16px}.time-display-clock{font-size:32px}}
</style>
</head>
<body>
<header class="app-header">
  <div class="header-inner">
    <div class="app-logo">
      <div class="logo-icon">üìã</div>
      <div><div class="app-title">AsistenciaQR</div><div class="app-subtitle">Control de Asistencia Escolar</div></div>
    </div>
    
  </div>
</header>
<nav class="nav-tabs">
  <div class="nav-tab active" data-tab="attendance"><span class="tab-icon">‚úì</span>Asistencia</div>
  <div class="nav-tab" data-tab="students"><span class="tab-icon">üë•</span>Alumnos</div>
  <div class="nav-tab" data-tab="absences"><span class="tab-icon">üìä</span>Reportes</div>
  <div class="nav-tab" data-tab="settings"><span class="tab-icon">‚öôÔ∏è</span>Configuraci√≥n</div>
</nav>
<main class="main-content">

<!-- PANEL: ASISTENCIA -->
<div id="panel-attendance" class="tab-panel active">
  <div class="time-display-card">
    <div class="time-display-clock" id="bigClock">00:00:00</div>
    <div class="time-display-date" id="bigDate">Cargando...</div>
    <div id="timeStatusBig"></div>
  </div>
  <div class="method-tabs">
    <div class="method-tab active" data-method="camera" onclick="selectMethod('camera')">üì∑ Escanear QR</div>
    <div class="method-tab" data-method="image" onclick="selectMethod('image')">üñºÔ∏è Desde Imagen</div>
    <div class="method-tab" data-method="manual" onclick="selectMethod('manual')">‚úçÔ∏è Manual</div>
  </div>
  <!-- C√ÅMARA -->
  <div id="method-camera" class="method-content active">
    <div class="card">
      <div class="card-header">
        <div class="card-title">üì∑ Escaneo con C√°mara</div>
        <button class="btn btn-accent btn-sm" onclick="toggleCamera()" id="cameraToggleBtn"><span id="cameraToggleText">‚ñ∂ Iniciar C√°mara</span></button>
      </div>
      <div class="camera-select-bar" id="cameraSelectBar" style="display:none">
        <label>üìπ C√°mara:</label>
        <select id="cameraSelect" class="form-select" style="flex:1" onchange="switchCamera()"></select>
      </div>
      <div id="cameraContainer" style="display:none">
        <div class="video-container">
          <video id="qrVideo" autoplay playsinline muted></video>
          <div class="scan-overlay"><div class="scan-frame"><div class="scan-corner tl"></div><div class="scan-corner tr"></div><div class="scan-corner bl"></div><div class="scan-corner br"></div><div class="scan-line"></div></div></div>
          <div class="camera-status" id="cameraStatus"><div class="camera-status-dot"></div><span>Inicializando...</span></div>
        </div>
      </div>
      <div id="scanResult"></div>
    </div>
  </div>
  <!-- IMAGEN -->
  <div id="method-image" class="method-content">
    <div class="card">
      <div class="card-header"><div class="card-title">üñºÔ∏è Escanear desde Imagen</div></div>
      <div class="btn-group" style="margin-bottom:16px">
        <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">üìÅ Seleccionar Archivo</button>
        <button class="btn btn-accent" onclick="document.getElementById('captureInput').click()">üì∏ Tomar Foto</button>
      </div>
      <input type="file" id="fileInput" accept="image/*" style="display:none">
      <input type="file" id="captureInput" accept="image/*" capture="environment" style="display:none">
      <div id="imageResult"></div>
    </div>
  </div>
  <!-- MANUAL -->
  <div id="method-manual" class="method-content">
    <div class="card">
      <div class="card-header"><div class="card-title">‚úçÔ∏è Registro Manual</div></div>
      <div class="filters-row">
        <div class="form-group"><label class="form-label">Buscar por Nombre</label><input type="text" id="manualNameSearch" class="form-input" placeholder="Escribe el nombre..." oninput="filterManualStudents()"></div>
        <div class="form-group"><label class="form-label">Filtrar por Grado</label><select id="manualGradeFilter" class="form-select" onchange="filterManualStudents()"><option value="">Todos</option></select></div>
        <div class="form-group"><label class="form-label">Alumno</label><select id="manualStudentSelect" class="form-select"><option value="">Seleccione...</option></select></div>
        <div class="form-group"><label class="form-label">Estado</label><select id="manualStatus" class="form-select"><option value="ontime">‚úÖ A tiempo</option><option value="late">‚è∞ Retardo</option></select></div>
      </div>
      <button class="btn btn-success btn-lg" style="width:100%" onclick="registerManual()">‚úì Registrar Asistencia</button>
    </div>
  </div>
  <div class="card">
    <div class="card-header"><div class="card-title">üìã Registros de Hoy</div><button class="btn btn-outline btn-sm" onclick="renderToday()">üîÑ</button></div>
    <div class="stats-grid" id="statsToday"></div>
    <div class="table-wrapper"><table id="tableToday"><thead><tr><th>Hora</th><th>Nombre</th><th>Grupo</th><th>Matr√≠cula</th><th>Estado</th></tr></thead><tbody></tbody></table></div>
  </div>
</div>

<!-- PANEL: ALUMNOS -->
<div id="panel-students" class="tab-panel">
  <div class="card">
    <div class="card-header"><div class="card-title">üë• Gesti√≥n de Alumnos</div></div>
    <div class="btn-group" style="margin-bottom:16px">
      <button class="btn btn-primary" onclick="openAddStudent()">‚ûï Agregar Alumno</button>
      <button class="btn btn-accent" onclick="openModal('modalImport')">üì§ Importar CSV</button>
      <button class="btn btn-outline" onclick="downloadCSVTemplate()">üìã Plantilla CSV</button>
      <button class="btn btn-success" onclick="exportStudentsCSV()">üíæ Exportar</button>
      <button class="btn btn-primary" onclick="generateAllQR()">üì± Generar Todos QR (ZIP)</button>
    </div>
    <div style="margin-bottom:16px"><input type="text" id="studentSearch" class="form-input" placeholder="üîç Buscar por nombre, matr√≠cula o grupo..." oninput="renderStudents()"></div>
    <div class="table-wrapper"><table id="tableStudents"><thead><tr><th>Nombre</th><th>Apellidos</th><th>Grupo</th><th>Matr√≠cula</th><th>Tutor</th><th>Tel√©fono</th><th>QR</th><th>Acciones</th></tr></thead><tbody></tbody></table></div>
    <div id="studentCount" style="margin-top:10px;font-size:12px;color:var(--text-muted);text-align:right"></div>
  </div>
</div>

<!-- PANEL: REPORTES -->
<div id="panel-absences" class="tab-panel">
  <div class="card">
    <div class="card-header"><div class="card-title">üìä Reportes de Asistencia</div></div>
    <div class="method-tabs">
      <div class="method-tab active" data-abs="absences" onclick="selectAbsType('absences')">üìõ Inasistencias</div>
      <div class="method-tab" data-abs="tardiness" onclick="selectAbsType('tardiness')">‚è∞ Retardos</div>
      <div class="method-tab" data-abs="individual" onclick="selectAbsType('individual')">üë§ Individual</div>
    </div>
    <div class="filters-row">
      <div class="form-group"><label class="form-label">Buscar Nombre</label><input type="text" id="filterName" class="form-input" placeholder="Nombre del alumno..." oninput="renderAbsences()"></div>
      <div class="form-group"><label class="form-label">Grado</label><select id="filterGrade" class="form-select" onchange="renderAbsences()"><option value="">Todos</option></select></div>
      <div class="form-group"><label class="form-label">Fecha</label><input type="date" id="filterDate" class="form-input" onchange="renderAbsences()"></div>
      <div class="form-group"><label class="form-label">Mes</label><input type="month" id="filterMonth" class="form-input" onchange="renderAbsences()"></div>
      <div class="form-group" id="filterStudentGroup"><label class="form-label">Alumno</label><select id="filterStudent" class="form-select" onchange="renderAbsences()"><option value="">Todos</option></select></div>
    </div>
    <div class="btn-group">
      <button class="btn btn-success" onclick="exportAbsences()">üì• Exportar Reporte CSV</button>
      <button class="btn btn-outline" onclick="clearFilters()">üóëÔ∏è Limpiar Filtros</button>
    </div>
  </div>
  <div class="card">
    <div class="card-header"><div class="card-title" id="absencesTitle">Resultados</div></div>
    <div id="absencesStats"></div>
    <div class="table-wrapper"><table id="tableAbsences"><thead><tr><th>Nombre</th><th>Grupo</th><th>Matr√≠cula</th><th>Fecha</th><th>Tipo</th><th>Hora</th><th>Justificada</th><th>Acciones</th></tr></thead><tbody></tbody></table></div>
  </div>
</div>

<!-- PANEL: CONFIGURACI√ìN -->
<div id="panel-settings" class="tab-panel">
  <div class="card">
    <div class="card-header"><div class="card-title">‚öôÔ∏è Configuraci√≥n General</div></div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Hora de Inicio de Clases</label><input type="time" id="settingStartTime" class="form-input" value="07:30"></div>
      <div class="form-group"><label class="form-label">Minutos para Retardo</label><input type="number" id="settingLateMinutes" class="form-input" min="1" max="60" value="5"><div style="font-size:11px;color:var(--text-muted);margin-top:4px">Despu√©s de este tiempo = Retardo</div></div>
      <div class="form-group"><label class="form-label">Inicio del Periodo</label><input type="date" id="settingSemesterStart" class="form-input"></div>
    </div>
    <button class="btn btn-primary btn-lg" onclick="saveSettings()" style="margin-top:8px">üíæ Guardar Configuraci√≥n</button>
  </div>
  <div class="card">
    <div class="card-header"><div class="card-title">üìÖ D√≠as Festivos / No Laborables</div><button class="btn btn-primary btn-sm" onclick="openModal('modalHoliday')">‚ûï Agregar</button></div>
    <div style="font-size:12px;color:var(--text-muted);margin-bottom:12px">Los d√≠as festivos no cuentan como falta.</div>
    <div id="holidaysList"></div>
  </div>
  <div class="card">
    <div class="card-header"><div class="card-title">üíæ Respaldo de Datos</div></div>
    <div class="btn-group">
      <button class="btn btn-success" onclick="exportBackup()">üì¶ Exportar Respaldo</button>
      <button class="btn btn-accent" onclick="document.getElementById('backupInput').click()">üì• Restaurar</button>
      <input type="file" id="backupInput" accept=".json" style="display:none" onchange="importBackup(event)">
    </div>
    <div style="font-size:12px;color:var(--text-muted);margin-top:8px">Incluye alumnos, asistencia, justificaciones, festivos y config.</div>
  </div>
  <div class="card" style="border-color:var(--danger)">
    <div class="card-header"><div class="card-title" style="color:var(--danger)">‚ö†Ô∏è Zona de Peligro</div></div>
    <div class="btn-group">
      <button class="btn btn-warning" onclick="resetAttendance()">üóëÔ∏è Resetear Asistencia</button>
      <button class="btn btn-danger" onclick="resetAll()">‚ö†Ô∏è Borrar Todo</button>
    </div>
  </div>
</div>
</main>

<!-- MODALES -->
<div id="modalStudent" class="modal-overlay"><div class="modal">
  <div class="modal-header"><div class="modal-title" id="studentModalTitle">‚ûï Agregar Alumno</div><button class="modal-close" onclick="closeModal('modalStudent')">‚úï</button></div>
  <div class="modal-body">
    <input type="hidden" id="studentId">
    <div class="form-row"><div class="form-group"><label class="form-label">Nombre(s) *</label><input type="text" id="studentFirstName" class="form-input" placeholder="Ej: Juan Carlos"></div><div class="form-group"><label class="form-label">Apellidos *</label><input type="text" id="studentLastName" class="form-input" placeholder="Ej: Garc√≠a L√≥pez"></div></div>
    <div class="form-row"><div class="form-group"><label class="form-label">Grupo / Grado *</label><input type="text" id="studentGrupo" class="form-input" placeholder="Ej: 3A"></div><div class="form-group"><label class="form-label">Matr√≠cula *</label><input type="text" id="studentMatricula" class="form-input" placeholder="Ej: 2024001"></div></div>
    <div class="form-row"><div class="form-group"><label class="form-label">Nombre del Tutor</label><input type="text" id="studentTutor" class="form-input" placeholder="Ej: Mar√≠a Garc√≠a"></div><div class="form-group"><label class="form-label">Tel√©fono del Tutor</label><input type="tel" id="studentPhone" class="form-input" placeholder="Ej: 8661234567"></div></div>
  </div>
  <div class="modal-footer"><button class="btn btn-outline" onclick="closeModal('modalStudent')">Cancelar</button><button class="btn btn-primary" onclick="saveStudent()">üíæ Guardar</button></div>
</div></div>

<div id="modalQR" class="modal-overlay"><div class="modal">
  <div class="modal-header"><div class="modal-title">üì± Credencial QR</div><button class="modal-close" onclick="closeModal('modalQR')">‚úï</button></div>
  <div class="modal-body">
    <div class="credential-preview" id="credentialPreview">
      <div class="credential-header">CREDENCIAL DE ASISTENCIA ESCOLAR</div>
      <div id="qrcode" style="display:flex;justify-content:center;margin-bottom:12px"></div>
      <div id="qrStudentName" style="font-size:16px;font-weight:700;color:var(--text);margin-bottom:4px"></div>
      <div id="qrStudentGrade" style="font-size:13px;color:var(--text-secondary);margin-bottom:4px"></div>
      <div id="qrStudentMat" style="font-size:12px;color:var(--text-muted)"></div>
    </div>
  </div>
  <div class="modal-footer"><button class="btn btn-primary" onclick="downloadCredentialQR()">üíæ Descargar Credencial</button><button class="btn btn-outline" onclick="closeModal('modalQR')">Cerrar</button></div>
</div></div>

<div id="modalImport" class="modal-overlay"><div class="modal">
  <div class="modal-header"><div class="modal-title">üì§ Importar Alumnos CSV</div><button class="modal-close" onclick="closeModal('modalImport')">‚úï</button></div>
  <div class="modal-body">
    <div class="template-info"><span class="template-info-icon">üí°</span><div><strong>Columnas:</strong> nombre, apellidos, grupo, matricula, tutor, telefono. La columna <code>id</code> es opcional.<br><br><button class="btn btn-outline btn-sm" onclick="downloadCSVTemplate()">üìã Descargar Plantilla</button></div></div>
    <div class="drop-zone" id="dropZone" onclick="document.getElementById('csvInput').click()"><div class="drop-zone-icon">üìÑ</div><div class="drop-zone-text">Clic o arrastra archivo CSV aqu√≠</div></div>
    <input type="file" id="csvInput" accept=".csv,.txt" style="display:none" onchange="importCSV(event)">
  </div>
</div></div>

<div id="modalJustify" class="modal-overlay"><div class="modal">
  <div class="modal-header"><div class="modal-title">üìù Justificar</div><button class="modal-close" onclick="closeModal('modalJustify')">‚úï</button></div>
  <div class="modal-body">
    <input type="hidden" id="justifyStudentId"><input type="hidden" id="justifyDate">
    <div id="justifyInfo" style="margin-bottom:14px;padding:14px;background:var(--bg);border-radius:var(--radius-sm);font-size:13px;border:1px solid var(--border)"></div>
    <div class="form-group"><label class="form-label">Motivo</label><textarea id="justifyReason" class="form-input" rows="4" placeholder="Motivo de la justificaci√≥n..." style="resize:vertical"></textarea></div>
  </div>
  <div class="modal-footer"><button class="btn btn-outline" onclick="closeModal('modalJustify')">Cancelar</button><button class="btn btn-primary" onclick="saveJustify()">üíæ Justificar</button></div>
</div></div>

<div id="modalHoliday" class="modal-overlay"><div class="modal">
  <div class="modal-header"><div class="modal-title">üìÖ D√≠a Festivo</div><button class="modal-close" onclick="closeModal('modalHoliday')">‚úï</button></div>
  <div class="modal-body">
    <div class="form-group"><label class="form-label">Fecha</label><input type="date" id="holidayDate" class="form-input"></div>
    <div class="form-group"><label class="form-label">Descripci√≥n</label><input type="text" id="holidayName" class="form-input" placeholder="Ej: D√≠a de la Independencia"></div>
  </div>
  <div class="modal-footer"><button class="btn btn-outline" onclick="closeModal('modalHoliday')">Cancelar</button><button class="btn btn-primary" onclick="addHoliday()">üíæ Guardar</button></div>
</div></div>

<div id="modalConfirm" class="modal-overlay"><div class="modal">
  <div class="modal-header"><div class="modal-title" id="confirmTitle">Confirmar</div><button class="modal-close" onclick="closeModal('modalConfirm')">‚úï</button></div>
  <div class="modal-body"><p id="confirmMessage" style="font-size:14px"></p></div>
  <div class="modal-footer"><button class="btn btn-outline" onclick="closeModal('modalConfirm')">Cancelar</button><button class="btn btn-danger" id="confirmBtn">Confirmar</button></div>
</div></div>

<div id="modalProgress" class="modal-overlay"><div class="modal" style="max-width:400px">
  <div class="modal-header"><div class="modal-title" id="progressTitle">Procesando...</div></div>
  <div class="modal-body" style="text-align:center"><div class="progress-bar-wrap"><div class="progress-bar-fill" id="progressBar"></div></div><div class="progress-text" id="progressText">0%</div></div>
</div></div>

<div class="toast-container" id="toastContainer"></div>

<script>
// ============================================================
// STATE
// ============================================================
const S={students:[],attendance:[],justifications:[],holidays:[],settings:{startTime:'07:30',lateMinutes:5,semesterStart:''},absType:'absences',cameraStream:null,cameraActive:false,scanningActive:false,cameras:[],currentQRStudent:null};

// ============================================================
// UTILS
// ============================================================
function today(){return new Date().toISOString().split('T')[0]}
function now(){return new Date().toLocaleTimeString('es-MX',{hour12:false})}
function fmtDate(d){try{return new Date(d+'T12:00:00').toLocaleDateString('es-MX',{day:'2-digit',month:'short',year:'numeric'})}catch(e){return d}}
function t2m(t){const[h,m]=t.split(':').map(Number);return h*60+m}
function fullName(s){return s.nombre+' '+s.apellidos}
function genId(){return Date.now().toString(36)+Math.random().toString(36).substr(2,8)}
function esc(s){const d=document.createElement('div');d.textContent=s;return d.innerHTML}

function toast(msg,type='success'){
  const c=document.getElementById('toastContainer');
  const t=document.createElement('div');
  t.className='toast '+type;
  t.innerHTML=(type==='success'?'‚úì':type==='error'?'‚úï':'‚Ñπ')+' '+msg;
  c.appendChild(t);
  setTimeout(()=>{t.style.opacity='0';t.style.transform='translateY(12px)';setTimeout(()=>t.remove(),300)},3000);
}
function openModal(id){document.getElementById(id).classList.add('active')}
function closeModal(id){document.getElementById(id).classList.remove('active')}
function confirm_(title,msg,cb){
  document.getElementById('confirmTitle').textContent=title;
  document.getElementById('confirmMessage').innerHTML=msg;
  document.getElementById('confirmBtn').onclick=()=>{cb();closeModal('modalConfirm')};
  openModal('modalConfirm');
}

// ============================================================
// PERSISTENCE
// ============================================================
function loadData(){
  try{
    S.students=JSON.parse(localStorage.getItem('aqr_students')||'[]');
    S.attendance=JSON.parse(localStorage.getItem('aqr_attendance')||'[]');
    S.justifications=JSON.parse(localStorage.getItem('aqr_justifications')||'[]');
    S.holidays=JSON.parse(localStorage.getItem('aqr_holidays')||'[]');
    const st=localStorage.getItem('aqr_settings');
    if(st)S.settings={...S.settings,...JSON.parse(st)};
  }catch(e){console.error('Load error:',e)}
}
function saveStudents(){localStorage.setItem('aqr_students',JSON.stringify(S.students))}
function saveAttendance(){localStorage.setItem('aqr_attendance',JSON.stringify(S.attendance))}
function saveJustifications(){localStorage.setItem('aqr_justifications',JSON.stringify(S.justifications))}
function saveHolidaysLS(){localStorage.setItem('aqr_holidays',JSON.stringify(S.holidays))}
function saveSettings(){
  S.settings.startTime=document.getElementById('settingStartTime').value||'07:30';
  S.settings.lateMinutes=parseInt(document.getElementById('settingLateMinutes').value)||5;
  S.settings.semesterStart=document.getElementById('settingSemesterStart').value;
  localStorage.setItem('aqr_settings',JSON.stringify(S.settings));
  toast('Configuraci√≥n guardada');
}

// ============================================================
// BACKUP
// ============================================================
function exportBackup(){
  const b={v:2,date:new Date().toISOString(),students:S.students,attendance:S.attendance,justifications:S.justifications,holidays:S.holidays,settings:S.settings};
  const blob=new Blob([JSON.stringify(b,null,2)],{type:'application/json'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='respaldo-asistencia-'+today()+'.json';a.click();
  toast('Respaldo exportado');
}
function importBackup(e){
  const f=e.target.files[0];if(!f)return;
  const r=new FileReader();
  r.onload=ev=>{
    try{
      const d=JSON.parse(ev.target.result);
      confirm_('Restaurar','‚ö†Ô∏è Esto reemplazar√° TODOS los datos. ¬øContinuar?',()=>{
        if(d.students){S.students=d.students;saveStudents()}
        if(d.attendance){S.attendance=d.attendance;saveAttendance()}
        if(d.justifications){S.justifications=d.justifications;saveJustifications()}
        if(d.holidays){S.holidays=d.holidays;saveHolidaysLS()}
        if(d.settings){S.settings={...S.settings,...d.settings};localStorage.setItem('aqr_settings',JSON.stringify(S.settings))}
        refreshAll();toast('Respaldo restaurado');
      });
    }catch(err){toast('Archivo inv√°lido','error')}
  };
  r.readAsText(f);e.target.value='';
}

// ============================================================
// HOLIDAYS
// ============================================================
function isHoliday(date){return S.holidays.some(h=>h.date===date)}
function addHoliday(){
  const date=document.getElementById('holidayDate').value;
  const name=document.getElementById('holidayName').value.trim();
  if(!date||!name){toast('Complete los campos','error');return}
  if(S.holidays.some(h=>h.date===date)){toast('Ya existe','error');return}
  S.holidays.push({date,name});S.holidays.sort((a,b)=>a.date.localeCompare(b.date));
  saveHolidaysLS();closeModal('modalHoliday');renderHolidays();
  document.getElementById('holidayDate').value='';document.getElementById('holidayName').value='';
  toast('D√≠a festivo agregado');
}
function removeHoliday(date){S.holidays=S.holidays.filter(h=>h.date!==date);saveHolidaysLS();renderHolidays();toast('Eliminado')}
function renderHolidays(){
  const c=document.getElementById('holidaysList');
  if(!S.holidays.length){c.innerHTML='<div class="table-empty" style="padding:20px">Sin d√≠as festivos</div>';return}
  c.innerHTML=S.holidays.map(h=>'<div class="holiday-item"><div><div class="holiday-date">üìÖ '+fmtDate(h.date)+'</div><div class="holiday-name">'+esc(h.name)+'</div></div><button class="btn btn-danger btn-sm" onclick="removeHoliday(\''+h.date+'\')">üóëÔ∏è</button></div>').join('');
}

// ============================================================
// STUDENTS
// ============================================================
function renderStudents(){
  const search=(document.getElementById('studentSearch')||{}).value||'';
  const sl=search.toLowerCase();
  let list=S.students;
  if(sl)list=list.filter(s=>fullName(s).toLowerCase().includes(sl)||s.matricula.toLowerCase().includes(sl)||s.grupo.toLowerCase().includes(sl));
  const tb=document.querySelector('#tableStudents tbody');
  if(!list.length){tb.innerHTML='<tr><td colspan="8" class="table-empty"><span class="table-empty-icon">üë•</span>'+(sl?'Sin resultados':'No hay alumnos')+'</td></tr>';document.getElementById('studentCount').textContent='';return}
  tb.innerHTML=list.map(s=>'<tr><td><strong>'+esc(s.nombre)+'</strong></td><td>'+esc(s.apellidos)+'</td><td><span class="badge badge-info">'+esc(s.grupo)+'</span></td><td>'+esc(s.matricula)+'</td><td>'+esc(s.tutor||'-')+'</td><td>'+esc(s.telefono||'-')+'</td><td><button class="btn btn-accent btn-sm" onclick="showQR(\''+s.id+'\')">üì± QR</button></td><td><div class="btn-group"><button class="btn btn-primary btn-sm" onclick="editStudent(\''+s.id+'\')">‚úèÔ∏è</button><button class="btn btn-danger btn-sm" onclick="deleteStudent(\''+s.id+'\')">üóëÔ∏è</button></div></td></tr>').join('');
  document.getElementById('studentCount').textContent=list.length+' de '+S.students.length+' alumnos';
}
function openAddStudent(){
  document.getElementById('studentModalTitle').textContent='‚ûï Agregar Alumno';
  ['studentId','studentFirstName','studentLastName','studentGrupo','studentMatricula','studentTutor','studentPhone'].forEach(id=>document.getElementById(id).value='');
  openModal('modalStudent');setTimeout(()=>document.getElementById('studentFirstName').focus(),100);
}
function editStudent(id){
  const s=S.students.find(x=>x.id===id);if(!s)return;
  document.getElementById('studentModalTitle').textContent='‚úèÔ∏è Editar Alumno';
  document.getElementById('studentId').value=s.id;
  document.getElementById('studentFirstName').value=s.nombre;
  document.getElementById('studentLastName').value=s.apellidos;
  document.getElementById('studentGrupo').value=s.grupo;
  document.getElementById('studentMatricula').value=s.matricula;
  document.getElementById('studentTutor').value=s.tutor||'';
  document.getElementById('studentPhone').value=s.telefono||'';
  openModal('modalStudent');setTimeout(()=>document.getElementById('studentFirstName').focus(),100);
}
function saveStudent(){
  const id=document.getElementById('studentId').value;
  const nombre=document.getElementById('studentFirstName').value.trim();
  const apellidos=document.getElementById('studentLastName').value.trim();
  const grupo=document.getElementById('studentGrupo').value.trim();
  const matricula=document.getElementById('studentMatricula').value.trim();
  const tutor=document.getElementById('studentTutor').value.trim();
  const telefono=document.getElementById('studentPhone').value.trim();
  if(!nombre||!apellidos||!grupo||!matricula){toast('Complete campos obligatorios (*)','error');return}
  if(id){const s=S.students.find(x=>x.id===id);if(s)Object.assign(s,{nombre,apellidos,grupo,matricula,tutor,telefono});toast('Actualizado');}
  else{if(S.students.some(s=>s.matricula===matricula)){toast('Matr√≠cula duplicada','error');return}S.students.push({id:genId(),nombre,apellidos,grupo,matricula,tutor,telefono});toast('Alumno agregado');}
  saveStudents();closeModal('modalStudent');renderStudents();updateSelectors();
}
function deleteStudent(id){
  const s=S.students.find(x=>x.id===id);if(!s)return;
  confirm_('Eliminar','¬øEliminar a <strong>'+esc(fullName(s))+'</strong>?',()=>{
    S.students=S.students.filter(x=>x.id!==id);
    S.attendance=S.attendance.filter(a=>a.studentId!==id);
    S.justifications=S.justifications.filter(j=>j.studentId!==id);
    saveStudents();saveAttendance();saveJustifications();renderStudents();renderToday();renderAbsences();updateSelectors();toast('Eliminado');
  });
}

// ============================================================
// CSV
// ============================================================
function downloadCSVTemplate(){
  const csv='nombre,apellidos,grupo,matricula,tutor,telefono\nJuan Carlos,Garc√≠a L√≥pez,3A,2024001,Mar√≠a Garc√≠a,8661234567\nAna,Mart√≠nez Ruiz,3B,2024002,Pedro Mart√≠nez,8669876543';
  const b=new Blob(['\ufeff'+csv],{type:'text/csv;charset=utf-8;'});
  const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='plantilla_alumnos.csv';a.click();toast('Plantilla descargada');
}
function importCSV(e){
  const f=e.target.files[0];if(!f)return;
  Papa.parse(f,{header:true,skipEmptyLines:true,complete:r=>{
    let c=0,sk=0;
    r.data.forEach(row=>{
      const nombre=(row.nombre||row.Nombre||'').trim();
      const apellidos=(row.apellidos||row.Apellidos||'').trim();
      const grupo=(row.grupo||row.Grupo||row.grado||row.Grado||'').trim();
      const matricula=(row.matricula||row.Matricula||'').trim();
      const tutor=(row.tutor||row.Tutor||'').trim();
      const telefono=(row.telefono||row.Telefono||row.celular||'').trim();
      const csvId=(row.id||row.ID||'').trim();
      if(nombre&&apellidos&&grupo&&matricula){
        const sid=csvId||genId();
        if(!S.students.find(s=>s.id===sid||s.matricula===matricula)){S.students.push({id:sid,nombre,apellidos,grupo,matricula,tutor,telefono});c++}else{sk++}
      }
    });
    saveStudents();closeModal('modalImport');renderStudents();updateSelectors();
    let msg=c+' alumno'+(c!==1?'s':'')+' importado'+(c!==1?'s':'');
    if(sk)msg+=' ('+sk+' duplicado'+(sk>1?'s':'')+')';
    toast(msg);
  },error:()=>toast('Error al leer CSV','error')});e.target.value='';
}
function exportStudentsCSV(){
  if(!S.students.length){toast('No hay alumnos','error');return}
  const data=S.students.map(s=>({id:s.id,nombre:s.nombre,apellidos:s.apellidos,grupo:s.grupo,matricula:s.matricula,tutor:s.tutor||'',telefono:s.telefono||''}));
  const csv=Papa.unparse(data);
  const b=new Blob(['\ufeff'+csv],{type:'text/csv;charset=utf-8;'});
  const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='alumnos_'+today()+'.csv';a.click();toast('Exportado');
}

// ============================================================
// QR - CREDENTIAL STYLE
// ============================================================
function showQR(id){
  const s=S.students.find(x=>x.id===id);if(!s)return;
  S.currentQRStudent=s;
  document.getElementById('qrcode').innerHTML='';
  new QRCode(document.getElementById('qrcode'),{text:s.id,width:180,height:180,correctLevel:QRCode.CorrectLevel.M});
  document.getElementById('qrStudentName').textContent=fullName(s);
  document.getElementById('qrStudentGrade').textContent='Grupo: '+s.grupo;
  document.getElementById('qrStudentMat').textContent='Matr√≠cula: '+s.matricula;
  openModal('modalQR');
}
function downloadCredentialQR(){
  const s=S.currentQRStudent;if(!s)return;
  const qc=document.querySelector('#qrcode canvas');if(!qc)return;
  const c=document.createElement('canvas'),ctx=c.getContext('2d'),W=400,H=540;
  c.width=W;c.height=H;
  ctx.fillStyle='#fff';ctx.fillRect(0,0,W,H);
  const g=ctx.createLinearGradient(0,0,W,0);g.addColorStop(0,'#0f2b46');g.addColorStop(1,'#1a5276');
  ctx.fillStyle=g;ctx.fillRect(0,0,W,70);
  ctx.fillStyle='#fff';ctx.font='bold 15px Arial';ctx.textAlign='center';
  ctx.fillText('CREDENCIAL DE ASISTENCIA ESCOLAR',W/2,32);
  ctx.font='11px Arial';ctx.globalAlpha=.7;ctx.fillText('AsistenciaQR - Control Escolar',W/2,52);ctx.globalAlpha=1;
  ctx.strokeStyle='#1e3a5f';ctx.lineWidth=3;ctx.strokeRect(1.5,1.5,W-3,H-3);
  ctx.drawImage(qc,(W-220)/2,90,220,220);
  ctx.strokeStyle='#e2e8f0';ctx.lineWidth=1;ctx.beginPath();ctx.moveTo(40,330);ctx.lineTo(W-40,330);ctx.stroke();
  ctx.fillStyle='#0f172a';const nm=fullName(s);
  ctx.font=nm.length>28?'bold 18px Arial':'bold 22px Arial';
  ctx.fillText(nm,W/2,370);
  ctx.fillStyle='#475569';ctx.font='600 16px Arial';ctx.fillText('Grupo: '+s.grupo,W/2,400);
  ctx.font='14px Arial';ctx.fillText('Matr√≠cula: '+s.matricula,W/2,428);
  ctx.fillStyle='#f1f5f9';ctx.fillRect(0,H-50,W,50);
  ctx.fillStyle='#94a3b8';ctx.font='11px Arial';
  ctx.fillText('Generado: '+new Date().toLocaleDateString('es-MX')+' | AsistenciaQR',W/2,H-25);
  const a=document.createElement('a');
  a.href=c.toDataURL('image/png');
  a.download='credencial_'+s.grupo+'_'+s.matricula+'_'+s.apellidos.replace(/\s/g,'_')+'.png';
  a.click();toast('Credencial descargada');
}

async function generateAllQR(){
  if(!S.students.length){toast('No hay alumnos','error');return}
  openModal('modalProgress');
  document.getElementById('progressTitle').textContent='Generando '+S.students.length+' credenciales...';
  const zip=new JSZip(),folder=zip.folder('credenciales-qr');
  const tmp=document.createElement('div');tmp.style.cssText='position:fixed;left:-9999px';document.body.appendChild(tmp);
  for(let i=0;i<S.students.length;i++){
    const s=S.students[i],pct=Math.round(((i+1)/S.students.length)*100);
    document.getElementById('progressBar').style.width=pct+'%';
    document.getElementById('progressText').textContent=(i+1)+' de '+S.students.length+' ('+pct+'%)';
    tmp.innerHTML='<div id="tmpQR"></div>';
    new QRCode(document.getElementById('tmpQR'),{text:s.id,width:250,height:250,correctLevel:QRCode.CorrectLevel.M});
    await new Promise(r=>setTimeout(r,80));
    const qc=tmp.querySelector('canvas');
    if(qc){
      const c=document.createElement('canvas'),ctx=c.getContext('2d'),W=400,H=540;
      c.width=W;c.height=H;ctx.fillStyle='#fff';ctx.fillRect(0,0,W,H);
      const g=ctx.createLinearGradient(0,0,W,0);g.addColorStop(0,'#0f2b46');g.addColorStop(1,'#1a5276');
      ctx.fillStyle=g;ctx.fillRect(0,0,W,70);ctx.fillStyle='#fff';ctx.font='bold 15px Arial';ctx.textAlign='center';
      ctx.fillText('CREDENCIAL DE ASISTENCIA ESCOLAR',W/2,32);ctx.font='11px Arial';ctx.globalAlpha=.7;
      ctx.fillText('AsistenciaQR - Control Escolar',W/2,52);ctx.globalAlpha=1;
      ctx.strokeStyle='#1e3a5f';ctx.lineWidth=3;ctx.strokeRect(1.5,1.5,W-3,H-3);
      ctx.drawImage(qc,(W-220)/2,90,220,220);
      ctx.strokeStyle='#e2e8f0';ctx.lineWidth=1;ctx.beginPath();ctx.moveTo(40,330);ctx.lineTo(W-40,330);ctx.stroke();
      ctx.fillStyle='#0f172a';const nm=fullName(s);ctx.font=nm.length>28?'bold 18px Arial':'bold 22px Arial';ctx.fillText(nm,W/2,370);
      ctx.fillStyle='#475569';ctx.font='600 16px Arial';ctx.fillText('Grupo: '+s.grupo,W/2,400);
      ctx.font='14px Arial';ctx.fillText('Matr√≠cula: '+s.matricula,W/2,428);
      ctx.fillStyle='#f1f5f9';ctx.fillRect(0,H-50,W,50);ctx.fillStyle='#94a3b8';ctx.font='11px Arial';ctx.fillText('AsistenciaQR',W/2,H-25);
      const d=c.toDataURL('image/png').split(',')[1];
      const fn=(s.grupo+'_'+s.matricula+'_'+s.apellidos+'_'+s.nombre+'.png').replace(/\s+/g,'_').replace(/[^a-zA-Z0-9._-]/g,'');
      folder.file(fn,d,{base64:true});
    }
  }
  document.body.removeChild(tmp);
  document.getElementById('progressText').textContent='Comprimiendo ZIP...';
  const content=await zip.generateAsync({type:'blob'});
  const a=document.createElement('a');a.href=URL.createObjectURL(content);a.download='credenciales-qr-'+today()+'.zip';a.click();
  closeModal('modalProgress');document.getElementById('progressBar').style.width='0%';
  toast(S.students.length+' credenciales generadas');
}

// ============================================================
// SELECTORS
// ============================================================
function updateSelectors(){
  const grades=[...new Set(S.students.map(s=>s.grupo))].sort();
  const gf=document.getElementById('manualGradeFilter');
  gf.innerHTML='<option value="">Todos</option>'+grades.map(g=>'<option value="'+g+'">'+g+'</option>').join('');
  const rgf=document.getElementById('filterGrade');
  rgf.innerHTML='<option value="">Todos</option>'+grades.map(g=>'<option value="'+g+'">'+g+'</option>').join('');
  const fs=document.getElementById('filterStudent');
  fs.innerHTML='<option value="">Todos</option>'+S.students.map(s=>'<option value="'+s.id+'">'+fullName(s)+' ('+s.grupo+')</option>').join('');
  filterManualStudents();
}
function filterManualStudents(){
  const grade=document.getElementById('manualGradeFilter').value;
  const search=(document.getElementById('manualNameSearch')||{}).value||'';
  const sl=search.toLowerCase();
  const sel=document.getElementById('manualStudentSelect');
  let f=S.students;
  if(grade)f=f.filter(s=>s.grupo===grade);
  if(sl)f=f.filter(s=>fullName(s).toLowerCase().includes(sl));
  sel.innerHTML='<option value="">Seleccione...</option>'+f.map(s=>'<option value="'+s.id+'">'+fullName(s)+' ('+s.grupo+' - '+s.matricula+')</option>').join('');
}

// ============================================================
// METHODS
// ============================================================
function selectMethod(m){
  document.querySelectorAll('.method-tab[data-method]').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.method-content').forEach(c=>c.classList.remove('active'));
  const tab=document.querySelector('.method-tab[data-method="'+m+'"]');if(tab)tab.classList.add('active');
  const panel=document.getElementById('method-'+m);if(panel)panel.classList.add('active');
  if(m!=='camera')stopCamera();
}

// ============================================================
// CAMERA (Fixed for Android/iOS/PC)
// ============================================================
async function enumerateCameras(){
  try{
    const devs=await navigator.mediaDevices.enumerateDevices();
    S.cameras=devs.filter(function(d){return d.kind==='videoinput'});
    var sel=document.getElementById('cameraSelect');
    if(!sel)return;
    sel.innerHTML='';
    for(var i=0;i<S.cameras.length;i++){
      var opt=document.createElement('option');
      opt.value=S.cameras[i].deviceId;
      opt.textContent=S.cameras[i].label||('C√°mara '+(i+1));
      sel.appendChild(opt);
    }
    if(S.cameras.length>1){
      document.getElementById('cameraSelectBar').style.display='flex';
      var back=S.cameras.find(function(c){return /back|trasera|rear|environment/i.test(c.label)});
      if(back)sel.value=back.deviceId;
    }
  }catch(e){console.warn('enumerateCameras error:',e)}
}

async function toggleCamera(){
  if(S.cameraActive){stopCamera()}
  else{await startCamera()}
}

async function testCameraPermission(){
  // Quick test to see if camera is even accessible in this context
  try{
    var testStream=await navigator.mediaDevices.getUserMedia({video:true,audio:false});
    testStream.getTracks().forEach(function(t){t.stop()});
    return true;
  }catch(e){
    console.error('Camera permission test failed:',e.name,e.message);
    if(e.name==='NotAllowedError'&&window.self!==window.top){
      // We're in an iframe and permission was denied
      return 'iframe';
    }
    return e.name;
  }
}

async function startCamera(deviceId){
  var video=document.getElementById('qrVideo');
  var container=document.getElementById('cameraContainer');
  var status=document.getElementById('cameraStatus');
  var toggleText=document.getElementById('cameraToggleText');

  try{
    // Check browser support
    if(!navigator.mediaDevices||typeof navigator.mediaDevices.getUserMedia!=='function'){
      toast('Tu navegador no soporta c√°mara. Usa Chrome o Safari actualizado.','error');
      return;
    }

    // Check if we are inside an iframe without camera permissions
    if(window.self!==window.top){
      console.log('Running inside iframe, testing camera access...');
      var permTest=await testCameraPermission();
      if(permTest==='iframe'){
        toast('‚ö†Ô∏è La c√°mara est√° bloqueada por el iframe. Se necesita agregar allow="camera" al iframe.','error');
        document.getElementById('scanResult').innerHTML='<div class="scan-result scan-result-error"><div class="scan-result-icon">üîí</div><div class="scan-result-content"><div class="scan-result-name">C√°mara bloqueada por iframe</div><div class="scan-result-meta">El administrador del sitio debe agregar el atributo <code>allow=\"camera *\"</code> al tag <code>&lt;iframe&gt;</code> donde se incrust√≥ este sistema.<br><br><strong>Ejemplo:</strong><br><code>&lt;iframe src=\"...\" allow=\"camera *\" &gt;</code></div></div></div>';
        return;
      }else if(permTest!==true){
        console.warn('Camera test returned:',permTest);
      }
    }

    // Stop any existing stream first
    if(S.cameraStream){
      try{S.cameraStream.getTracks().forEach(function(t){t.stop()})}catch(e){}
      S.cameraStream=null;
      video.srcObject=null;
    }

    // Build constraints - KEY FIX: don't use exact with empty deviceId
    var constraints;
    var selId=deviceId||'';
    if(!selId){
      // Try to get select value, but it might be empty on first load
      var selEl=document.getElementById('cameraSelect');
      if(selEl&&selEl.value)selId=selEl.value;
    }

    if(selId&&selId.length>5){
      // We have a specific device ID
      constraints={video:{deviceId:{exact:selId}},audio:false};
    }else{
      // No specific device - prefer back camera on mobile
      constraints={video:{facingMode:'environment',width:{ideal:1280},height:{ideal:720}},audio:false};
    }

    console.log('Camera constraints:',JSON.stringify(constraints));

    // Try to get camera with preferred constraints
    try{
      S.cameraStream=await navigator.mediaDevices.getUserMedia(constraints);
    }catch(e1){
      console.warn('Primary camera failed, trying fallback:',e1.name,e1.message);
      // Fallback 1: try with just facingMode
      try{
        S.cameraStream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'},audio:false});
      }catch(e2){
        console.warn('Fallback 1 failed, trying any camera:',e2.name);
        // Fallback 2: try any camera at all
        try{
          S.cameraStream=await navigator.mediaDevices.getUserMedia({video:true,audio:false});
        }catch(e3){
          console.warn('Fallback 2 failed, trying user-facing:',e3.name);
          // Fallback 3: front camera
          S.cameraStream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'user'},audio:false});
        }
      }
    }

    if(!S.cameraStream){
      toast('No se pudo acceder a la c√°mara','error');
      return;
    }

    // Set video source
    video.srcObject=S.cameraStream;
    video.setAttribute('autoplay','');
    video.setAttribute('playsinline','');
    video.setAttribute('muted','');
    video.muted=true;

    // Show container
    container.style.display='block';
    S.cameraActive=true;
    S.scanningActive=true;

    // Update UI
    status.classList.add('active');
    status.innerHTML='<div class="camera-status-dot"></div><span>Escaneando...</span>';
    toggleText.textContent='‚è∏ Detener';

    // Enumerate cameras after we have permission
    await enumerateCameras();

    // Wait for video to be ready then start scanning
    video.onloadedmetadata=function(){
      console.log('Video metadata loaded, dimensions:',video.videoWidth,'x',video.videoHeight);
      video.play().then(function(){
        console.log('Video playing, starting QR scan loop');
        requestAnimationFrame(scanQRLoop);
        toast('C√°mara activa ‚Äî apunte el QR al recuadro','info');
      }).catch(function(playErr){
        console.error('Video play error:',playErr);
        // On iOS, sometimes we need user gesture to play
        toast('Toca el video para activar la c√°mara','info');
        video.addEventListener('click',function(){
          video.play().then(function(){
            requestAnimationFrame(scanQRLoop);
          });
        },{once:true});
      });
    };

    // Also try to play immediately (works on most Android)
    try{await video.play()}catch(e){/* handled by onloadedmetadata */}

  }catch(err){
    console.error('Camera error:',err.name,err.message);
    var msg='Error al acceder a la c√°mara';
    if(err.name==='NotAllowedError'||err.name==='PermissionDeniedError'){
      msg='‚ùå Permiso de c√°mara denegado. Ve a Configuraci√≥n del navegador > Permisos > C√°mara y habil√≠tala para este sitio.';
    }else if(err.name==='NotFoundError'||err.name==='DevicesNotFoundError'){
      msg='‚ùå No se encontr√≥ ninguna c√°mara en el dispositivo';
    }else if(err.name==='NotReadableError'||err.name==='TrackStartError'){
      msg='‚ùå La c√°mara est√° siendo usada por otra app. Cierra otras apps y vuelve a intentar.';
    }else if(err.name==='OverconstrainedError'){
      msg='‚ùå Error de configuraci√≥n de c√°mara. Intenta de nuevo.';
    }else if(err.name==='SecurityError'){
      if(window.self!==window.top){
        msg='üîí C√°mara bloqueada. El iframe necesita: allow="camera *"';
      }else{
        msg='‚ö†Ô∏è Se requiere HTTPS para usar la c√°mara.';
      }
    }else if(err.name==='AbortError'){
      msg='‚ùå La solicitud de c√°mara fue cancelada. Intenta de nuevo.';
    }
    toast(msg,'error');
    stopCamera();
  }
}

function switchCamera(){
  var sel=document.getElementById('cameraSelect');
  if(S.cameraActive&&sel&&sel.value){
    startCamera(sel.value);
  }
}

function stopCamera(){
  S.cameraActive=false;
  S.scanningActive=false;
  if(S.cameraStream){
    try{S.cameraStream.getTracks().forEach(function(t){t.stop()})}catch(e){}
    S.cameraStream=null;
  }
  var video=document.getElementById('qrVideo');
  if(video)video.srcObject=null;
  var container=document.getElementById('cameraContainer');
  if(container)container.style.display='none';
  var selectBar=document.getElementById('cameraSelectBar');
  if(selectBar)selectBar.style.display='none';
  var status=document.getElementById('cameraStatus');
  if(status){status.classList.remove('active');status.innerHTML='<div class="camera-status-dot"></div><span>Detenido</span>'}
  var toggleText=document.getElementById('cameraToggleText');
  if(toggleText)toggleText.textContent='‚ñ∂ Iniciar C√°mara';
  var scanResult=document.getElementById('scanResult');
  if(scanResult)scanResult.innerHTML='';
}

// Persistent canvas for scanning (avoid creating new one each frame)
var _scanCanvas=null;
var _scanCtx=null;

function scanQRLoop(){
  if(!S.scanningActive||!S.cameraActive)return;
  var video=document.getElementById('qrVideo');
  if(!video||!video.srcObject)return;

  if(video.readyState>=video.HAVE_CURRENT_DATA&&video.videoWidth>0&&video.videoHeight>0){
    if(!_scanCanvas){
      _scanCanvas=document.createElement('canvas');
      _scanCtx=_scanCanvas.getContext('2d',{willReadFrequently:true});
    }
    if(_scanCanvas.width!==video.videoWidth||_scanCanvas.height!==video.videoHeight){
      _scanCanvas.width=video.videoWidth;
      _scanCanvas.height=video.videoHeight;
    }
    _scanCtx.drawImage(video,0,0);
    try{
      var imageData=_scanCtx.getImageData(0,0,_scanCanvas.width,_scanCanvas.height);
      var code=jsQR(imageData.data,imageData.width,imageData.height,{inversionAttempts:'dontInvert'});
      if(code&&code.data&&code.data.length>0){
        processQR(code.data,'camera');
        S.scanningActive=false;
        setTimeout(function(){
          if(S.cameraActive){S.scanningActive=true;requestAnimationFrame(scanQRLoop)}
        },2000);
        return;
      }
    }catch(e){console.warn('QR scan error:',e)}
  }
  requestAnimationFrame(scanQRLoop);
}
function processQR(data,source){
  const s=S.students.find(x=>x.id===data);
  if(!s){showScan('error','‚ùå','QR no reconocido','No corresponde a ning√∫n alumno registrado');return}
  const td=today(),ex=S.attendance.find(a=>a.studentId===data&&a.date===td);
  if(ex){showScan('warning','‚ö†Ô∏è','Ya registrado',fullName(s)+' ‚Äî '+ex.time);playBeep(false);return}
  const tm=now(),sm=t2m(S.settings.startTime),nm=new Date().getHours()*60+new Date().getMinutes();
  const lm=sm+S.settings.lateMinutes,st=nm<=lm?'ontime':'late';
  const ua=navigator.userAgent,dev=/Mobi|Android/i.test(ua)?'Celular':'PC';
  const br=/Chrome/i.test(ua)?'Chrome':/Safari/i.test(ua)?'Safari':'Otro';
  S.attendance.push({studentId:data,date:td,time:tm,status:st,source,device:dev,browser:br});
  saveAttendance();renderToday();
  showScan(st==='ontime'?'success':'warning',st==='ontime'?'‚úÖ':'‚è∞',fullName(s),s.grupo+' | '+(st==='ontime'?'A TIEMPO':'RETARDO')+' ‚Äî '+tm);
  playBeep(st==='ontime');
}
function showScan(type,icon,title,detail){
  const cls=type==='success'?'scan-result-success':type==='warning'?'scan-result-warning':'scan-result-error';
  document.getElementById('scanResult').innerHTML='<div class="scan-result '+cls+'"><div class="scan-result-icon">'+icon+'</div><div class="scan-result-content"><div class="scan-result-name">'+title+'</div><div class="scan-result-meta">'+detail+'</div></div></div>';
}
function playBeep(ok){try{const c=new(window.AudioContext||window.webkitAudioContext)(),o=c.createOscillator(),g=c.createGain();o.connect(g);g.connect(c.destination);o.frequency.value=ok?880:440;o.type='sine';g.gain.setValueAtTime(.2,c.currentTime);g.gain.exponentialRampToValueAtTime(.001,c.currentTime+.15);o.start(c.currentTime);o.stop(c.currentTime+.15)}catch(e){}}

// ============================================================
// IMAGE SCAN
// ============================================================
function handleImageUpload(e){
  const f=e.target.files[0];if(!f)return;
  const r=new FileReader();
  r.onload=ev=>{
    const img=new Image();
    img.onload=()=>{
      const c=document.createElement('canvas');c.width=img.width;c.height=img.height;
      const ctx=c.getContext('2d');ctx.drawImage(img,0,0);
      const id=ctx.getImageData(0,0,c.width,c.height);
      const code=jsQR(id.data,id.width,id.height);
      if(code&&code.data)processImageQR(code.data);
      else document.getElementById('imageResult').innerHTML='<div class="scan-result scan-result-error"><div class="scan-result-icon">‚ö†Ô∏è</div><div class="scan-result-content"><div class="scan-result-name">No se detect√≥ QR</div><div class="scan-result-meta">Aseg√∫rese que la imagen sea clara</div></div></div>';
    };img.src=ev.target.result;
  };r.readAsDataURL(f);e.target.value='';
}
function processImageQR(data){
  const s=S.students.find(x=>x.id===data),el=document.getElementById('imageResult');
  if(!s){el.innerHTML='<div class="scan-result scan-result-error"><div class="scan-result-icon">‚ùå</div><div class="scan-result-content"><div class="scan-result-name">No reconocido</div><div class="scan-result-meta">QR no registrado</div></div></div>';return}
  const td=today(),ex=S.attendance.find(a=>a.studentId===data&&a.date===td);
  if(ex){el.innerHTML='<div class="scan-result scan-result-warning"><div class="scan-result-icon">‚ö†Ô∏è</div><div class="scan-result-content"><div class="scan-result-name">Ya registrado</div><div class="scan-result-meta">'+fullName(s)+' ‚Äî '+ex.time+'</div></div></div>';return}
  const tm=now(),sm=t2m(S.settings.startTime),nm=new Date().getHours()*60+new Date().getMinutes(),lm=sm+S.settings.lateMinutes,st=nm<=lm?'ontime':'late';
  S.attendance.push({studentId:data,date:td,time:tm,status:st,source:'image',device:'N/A',browser:'N/A'});
  saveAttendance();renderToday();
  const cls=st==='ontime'?'scan-result-success':'scan-result-warning',ic=st==='ontime'?'‚úÖ':'‚è∞';
  el.innerHTML='<div class="scan-result '+cls+'"><div class="scan-result-icon">'+ic+'</div><div class="scan-result-content"><div class="scan-result-name">'+fullName(s)+'</div><div class="scan-result-meta">'+s.grupo+' | '+(st==='ontime'?'A TIEMPO':'RETARDO')+' ‚Äî '+tm+'</div></div></div>';
  playBeep(st==='ontime');
}

// ============================================================
// MANUAL
// ============================================================
function registerManual(){
  const sid=document.getElementById('manualStudentSelect').value;
  if(!sid){toast('Seleccione alumno','error');return}
  const s=S.students.find(x=>x.id===sid);if(!s)return;
  const td=today(),ex=S.attendance.find(a=>a.studentId===sid&&a.date===td);
  if(ex){toast(fullName(s)+' ya registrado','error');return}
  const tm=now(),st=document.getElementById('manualStatus').value;
  S.attendance.push({studentId:sid,date:td,time:tm,status:st,source:'manual',device:'N/A',browser:'N/A'});
  saveAttendance();renderToday();toast(fullName(s)+' ‚Äî '+(st==='ontime'?'A tiempo':'Retardo'));
  document.getElementById('manualStudentSelect').value='';
}

// ============================================================
// TODAY
// ============================================================
function renderToday(){
  const td=today(),ta=S.attendance.filter(a=>a.date===td);
  const ont=ta.filter(a=>a.status==='ontime').length,lat=ta.filter(a=>a.status==='late').length;
  const abs=Math.max(0,S.students.length-ta.length);
  document.getElementById('statsToday').innerHTML=
    '<div class="stat-card"><div class="stat-number" style="color:var(--success)">'+ont+'</div><div class="stat-label">A Tiempo</div></div>'+
    '<div class="stat-card"><div class="stat-number" style="color:var(--warning)">'+lat+'</div><div class="stat-label">Retardos</div></div>'+
    '<div class="stat-card"><div class="stat-number" style="color:var(--danger)">'+abs+'</div><div class="stat-label">Ausentes</div></div>'+
    '<div class="stat-card"><div class="stat-number" style="color:var(--primary)">'+ta.length+'/'+S.students.length+'</div><div class="stat-label">Total</div></div>';
  const tb=document.querySelector('#tableToday tbody');
  if(!ta.length){tb.innerHTML='<tr><td colspan="5" class="table-empty"><span class="table-empty-icon">üìã</span>Sin registros</td></tr>';return}
  const sorted=[...ta].sort((a,b)=>b.time.localeCompare(a.time));
  tb.innerHTML=sorted.map(a=>{const s=S.students.find(x=>x.id===a.studentId);if(!s)return'';
    return'<tr><td><strong>'+a.time+'</strong></td><td>'+fullName(s)+'</td><td><span class="badge badge-info">'+s.grupo+'</span></td><td>'+s.matricula+'</td><td><span class="badge '+(a.status==='ontime'?'badge-success':'badge-warning')+'">'+(a.status==='ontime'?'A Tiempo':'Retardo')+'</span></td></tr>'}).join('');
}

// ============================================================
// REPORTS
// ============================================================
function selectAbsType(t){
  S.absType=t;
  document.querySelectorAll('.method-tab[data-abs]').forEach(x=>x.classList.remove('active'));
  const tab=document.querySelector('.method-tab[data-abs="'+t+'"]');if(tab)tab.classList.add('active');
  renderAbsences();
}
function clearFilters(){
  ['filterDate','filterMonth','filterStudent','filterName','filterGrade'].forEach(id=>{const el=document.getElementById(id);if(el)el.value=''});
  renderAbsences();toast('Filtros limpiados','info');
}
function getSchoolDates(){
  if(!S.settings.semesterStart)return[...new Set(S.attendance.map(a=>a.date))].sort();
  const st=new Date(S.settings.semesterStart+'T12:00:00'),ed=new Date(),dates=[];
  for(let d=new Date(st);d<=ed;d.setDate(d.getDate()+1)){const ds=d.toISOString().split('T')[0],wd=d.getDay();if(wd!==0&&wd!==6&&!isHoliday(ds))dates.push(ds)}
  return dates;
}
function renderAbsences(){
  const t=S.absType,fd=document.getElementById('filterDate').value,fm=document.getElementById('filterMonth').value;
  const fs=document.getElementById('filterStudent').value,fn=(document.getElementById('filterName')||{}).value||'';
  const fg=document.getElementById('filterGrade').value,fnl=fn.toLowerCase();
  let recs=[];
  if(t==='absences'||t==='individual'){
    getSchoolDates().filter(d=>{if(fd&&d!==fd)return false;if(fm&&!d.startsWith(fm))return false;return true}).forEach(date=>{
      const aids=S.attendance.filter(a=>a.date===date).map(a=>a.studentId);
      S.students.forEach(s=>{
        if(fs&&s.id!==fs)return;if(fnl&&!fullName(s).toLowerCase().includes(fnl))return;if(fg&&s.grupo!==fg)return;
        if(!aids.includes(s.id)){const j=S.justifications.find(jj=>jj.studentId===s.id&&jj.date===date);
          recs.push({student:s,date,type:'Inasistencia',time:'',justified:j,reason:j?j.reason:''})}
      });
    });
  }
  if(t==='tardiness'||t==='individual'){
    let tr=S.attendance.filter(a=>a.status==='late');
    if(fd)tr=tr.filter(a=>a.date===fd);if(fm)tr=tr.filter(a=>a.date.startsWith(fm));if(fs)tr=tr.filter(a=>a.studentId===fs);
    tr.forEach(r=>{const s=S.students.find(x=>x.id===r.studentId);if(!s)return;
      if(fnl&&!fullName(s).toLowerCase().includes(fnl))return;if(fg&&s.grupo!==fg)return;
      const j=S.justifications.find(jj=>jj.studentId===r.studentId&&jj.date===r.date);
      recs.push({student:s,date:r.date,type:'Retardo',time:r.time,justified:j,reason:j?j.reason:''});
    });
  }
  recs.sort((a,b)=>b.date.localeCompare(a.date));
  const titles={absences:'Inasistencias',tardiness:'Retardos',individual:'Individual'};
  document.getElementById('absencesTitle').textContent=(titles[t]||'Resultados')+' ('+recs.length+')';
  const tb=document.querySelector('#tableAbsences tbody');
  if(!recs.length){tb.innerHTML='<tr><td colspan="8" class="table-empty"><span class="table-empty-icon">üìä</span>Sin resultados</td></tr>';document.getElementById('absencesStats').innerHTML='';return}
  const tot=recs.length,jus=recs.filter(r=>r.justified).length,unj=tot-jus;
  document.getElementById('absencesStats').innerHTML='<div class="stats-grid"><div class="stat-card"><div class="stat-number" style="color:var(--primary)">'+tot+'</div><div class="stat-label">Total</div></div><div class="stat-card"><div class="stat-number" style="color:var(--success)">'+jus+'</div><div class="stat-label">Justificadas</div></div><div class="stat-card"><div class="stat-number" style="color:var(--danger)">'+unj+'</div><div class="stat-label">Sin Justificar</div></div></div>';
  tb.innerHTML=recs.map(r=>{const s=r.student;
    const jb=r.justified?'<span class="badge badge-success" title="'+esc(r.reason)+'">S√≠</span>':'<span class="badge badge-danger">No</span>';
    const bt=r.type==='Retardo'?'badge-warning':'badge-danger';
    const wa=s.telefono?'<button class="btn btn-whatsapp btn-sm" onclick="sendWA(\''+s.telefono+'\',\''+esc(fullName(s)).replace(/'/g,"\'")+'\',\''+r.date+'\',\''+r.type+'\')">üì± WA</button>':'';
    return'<tr><td><strong>'+esc(fullName(s))+'</strong></td><td><span class="badge badge-info">'+esc(s.grupo)+'</span></td><td>'+esc(s.matricula)+'</td><td>'+fmtDate(r.date)+'</td><td><span class="badge '+bt+'">'+r.type+'</span></td><td>'+(r.time||'‚Äî')+'</td><td>'+jb+'</td><td><div class="btn-group"><button class="btn btn-primary btn-sm" onclick="justifyAbsence(\''+s.id+'\',\''+r.date+'\')">üìù</button>'+wa+'</div></td></tr>'
  }).join('');
}
function justifyAbsence(sid,date){
  const s=S.students.find(x=>x.id===sid);if(!s)return;
  document.getElementById('justifyStudentId').value=sid;
  document.getElementById('justifyDate').value=date;
  const ex=S.justifications.find(j=>j.studentId===sid&&j.date===date);
  document.getElementById('justifyReason').value=ex?ex.reason:'';
  document.getElementById('justifyInfo').innerHTML='<strong>'+esc(fullName(s))+'</strong><br>Grupo: '+esc(s.grupo)+' | Fecha: '+fmtDate(date);
  openModal('modalJustify');setTimeout(()=>document.getElementById('justifyReason').focus(),100);
}
function saveJustify(){
  const sid=document.getElementById('justifyStudentId').value,date=document.getElementById('justifyDate').value;
  const reason=document.getElementById('justifyReason').value.trim();
  if(!reason){toast('Escribe el motivo','error');return}
  S.justifications=S.justifications.filter(j=>!(j.studentId===sid&&j.date===date));
  S.justifications.push({studentId:sid,date,reason});
  saveJustifications();closeModal('modalJustify');renderAbsences();toast('Justificada');
}
function sendWA(phone,name,date,type){
  let p=phone.replace(/\D/g,'');if(p.length===10)p='52'+p;
  const t=type==='Retardo'?'retardo':'inasistencia';
  const msg=encodeURIComponent('Estimado padre/tutor de '+name+':\n\nSe registr√≥ una '+t+' el d√≠a '+fmtDate(date)+'.\n\nFavor de indicar el motivo.\n\nAtte. Control de Asistencia Escolar');
  window.open('https://wa.me/'+p+'?text='+msg,'_blank');
}

// ============================================================
// EXPORT
// ============================================================
function exportAbsences(){
  const t=S.absType,fd=document.getElementById('filterDate').value,fm=document.getElementById('filterMonth').value;
  const fs=document.getElementById('filterStudent').value,fn=(document.getElementById('filterName')||{}).value||'';
  const fg=document.getElementById('filterGrade').value,fnl=fn.toLowerCase();
  let recs=[];
  if(t==='absences'||t==='individual'){
    getSchoolDates().filter(d=>{if(fd&&d!==fd)return false;if(fm&&!d.startsWith(fm))return false;return true}).forEach(date=>{
      const aids=S.attendance.filter(a=>a.date===date).map(a=>a.studentId);
      S.students.forEach(s=>{if(fs&&s.id!==fs)return;if(fnl&&!fullName(s).toLowerCase().includes(fnl))return;if(fg&&s.grupo!==fg)return;
        if(!aids.includes(s.id)){const j=S.justifications.find(jj=>jj.studentId===s.id&&jj.date===date);
          recs.push({Nombre:fullName(s),Grupo:s.grupo,Matricula:s.matricula,Fecha:date,Tipo:'Inasistencia',Hora:'',Justificada:j?'S√≠':'No',Motivo:j?j.reason:''})}});
    });
  }
  if(t==='tardiness'||t==='individual'){
    let tr=S.attendance.filter(a=>a.status==='late');
    if(fd)tr=tr.filter(a=>a.date===fd);if(fm)tr=tr.filter(a=>a.date.startsWith(fm));if(fs)tr=tr.filter(a=>a.studentId===fs);
    tr.forEach(r=>{const s=S.students.find(x=>x.id===r.studentId);if(!s)return;if(fnl&&!fullName(s).toLowerCase().includes(fnl))return;if(fg&&s.grupo!==fg)return;
      const j=S.justifications.find(jj=>jj.studentId===r.studentId&&jj.date===r.date);
      recs.push({Nombre:fullName(s),Grupo:s.grupo,Matricula:s.matricula,Fecha:r.date,Tipo:'Retardo',Hora:r.time,Justificada:j?'S√≠':'No',Motivo:j?j.reason:''});
    });
  }
  if(!recs.length){toast('Sin datos','error');return}
  const csv=Papa.unparse(recs);const b=new Blob(['\ufeff'+csv],{type:'text/csv;charset=utf-8;'});
  const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='reporte_'+t+'_'+today()+'.csv';a.click();toast('Exportado');
}

// ============================================================
// RESET
// ============================================================
function resetAttendance(){confirm_('Resetear','‚ö†Ô∏è ¬øBorrar TODOS los registros de asistencia?',()=>{S.attendance=[];S.justifications=[];saveAttendance();saveJustifications();renderToday();renderAbsences();toast('Reseteado','info')})}
function resetAll(){confirm_('Borrar Todo','üö® ¬øBORRAR TODO? Esto es IRREVERSIBLE.',()=>{S.students=[];S.attendance=[];S.justifications=[];S.holidays=[];S.settings={startTime:'07:30',lateMinutes:5,semesterStart:''};saveStudents();saveAttendance();saveJustifications();saveHolidaysLS();localStorage.setItem('aqr_settings',JSON.stringify(S.settings));refreshAll();toast('Sistema reseteado','info')})}

// ============================================================
// TABS
// ============================================================
document.querySelectorAll('.nav-tab').forEach(tab=>{
  tab.addEventListener('click',()=>{
    document.querySelectorAll('.nav-tab').forEach(t=>t.classList.remove('active'));
    document.querySelectorAll('.tab-panel').forEach(p=>p.classList.remove('active'));
    tab.classList.add('active');
    const panel=document.getElementById('panel-'+tab.dataset.tab);if(panel)panel.classList.add('active');
    if(tab.dataset.tab==='attendance')renderToday();
    else if(tab.dataset.tab==='absences')renderAbsences();
    else if(tab.dataset.tab==='students')renderStudents();
    else if(tab.dataset.tab==='settings')renderHolidays();
  });
});

// ============================================================
// CLOCK
// ============================================================
function updateClock(){
  const n=new Date();
  const ts=n.toLocaleTimeString('es-MX',{hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:false});
  const ds=n.toLocaleDateString('es-MX',{weekday:'long',day:'numeric',month:'long',year:'numeric'});
  // header clock removed
  // header date removed
  const bc=document.getElementById('bigClock');if(bc)bc.textContent=ts;
  const bd=document.getElementById('bigDate');if(bd)bd.textContent=ds.charAt(0).toUpperCase()+ds.slice(1);
  const sm=t2m(S.settings.startTime),nm=n.getHours()*60+n.getMinutes(),lm=sm+S.settings.lateMinutes;
  const st=document.getElementById('timeStatusBig');
  if(st){
    if(nm<sm)st.innerHTML='<div class="time-display-status status-before">‚è≥ Antes del horario ‚Äî Inicio: '+S.settings.startTime+'</div>';
    else if(nm<=lm)st.innerHTML='<div class="time-display-status status-ontime">‚úÖ Dentro del horario ‚Äî A TIEMPO</div>';
    else st.innerHTML='<div class="time-display-status status-late">‚è∞ Fuera de horario ‚Äî RETARDO (+'+S.settings.lateMinutes+' min)</div>';
  }
}

// ============================================================
// REFRESH & INIT
// ============================================================
function refreshAll(){
  document.getElementById('settingStartTime').value=S.settings.startTime;
  document.getElementById('settingLateMinutes').value=S.settings.lateMinutes;
  document.getElementById('settingSemesterStart').value=S.settings.semesterStart||'';
  renderStudents();updateSelectors();renderToday();renderAbsences();renderHolidays();updateClock();
}
function setupDropZone(){
  const dz=document.getElementById('dropZone');if(!dz)return;
  dz.addEventListener('dragover',e=>{e.preventDefault();dz.classList.add('dragover')});
  dz.addEventListener('dragleave',()=>dz.classList.remove('dragover'));
  dz.addEventListener('drop',e=>{e.preventDefault();dz.classList.remove('dragover');
    const f=e.dataTransfer.files[0];
    if(f&&(f.name.endsWith('.csv')||f.type==='text/csv')){importCSV({target:{files:[f],value:''}})}
    else toast('Solo archivos CSV','error');
  });
}
function init(){
  loadData();refreshAll();setInterval(updateClock,1000);
  document.getElementById('filterDate').value='';
  selectMethod('camera');
  document.getElementById('fileInput').addEventListener('change',handleImageUpload);
  document.getElementById('captureInput').addEventListener('change',handleImageUpload);
  setupDropZone();
  document.querySelectorAll('.modal-overlay').forEach(o=>o.addEventListener('click',e=>{if(e.target===o)o.classList.remove('active')}));
  document.addEventListener('keydown',e=>{if(e.key==='Escape')document.querySelectorAll('.modal-overlay.active').forEach(m=>m.classList.remove('active'))});
}
init();
</script>
</body>
</html>